{% extends "base.html" %}
{% block title %} Mapbox {% endblock %}

{% block body %}

<link href='https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css' rel='stylesheet' />
<script src="{{ url_for('static', filename='three.min.js') }}"></script>

<script src='https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js'></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script src="https://unpkg.com/three@0.126.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/nav.css')}}">

<style>
  #map { 
    width: 100%; 
    height: 500px;
    margin: auto;
  }
  .control-panel {
    display: flex;
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 10px;
  }

  #toggle-markers-btn {
    padding: 5px 10px; 
    font-size: 0.8em; 
  }

  .menu-icon {
    display: flex;
    align-items: center;
    font-size: 24px; 
  }
</style>

<div class='control-panel'>
  <div id='style-selector' class="map-overlay top">
    <select id='style-list'>
      <option value='mapbox://styles/mapbox/streets-v11'>Streets</option>
      <option value='mapbox://styles/mapbox/outdoors-v11'>Outdoors</option>
      <option value='mapbox://styles/mapbox/light-v10'>Light</option>
      <option value='mapbox://styles/mapbox/dark-v10'>Dark</option>
      <option value='mapbox://styles/mapbox/satellite-v9'>Satellite</option>
      <option value='mapbox://styles/mapbox/satellite-streets-v11'>Satellite Streets</option>
    </select>
  </div>

  <!-- Botón para activar la vista en primera persona -->
  <button id="toggle-markers-btn">First Person View</button>

  <div class="menu-icon">&#9776;</div> 
</div>

<div id='map'></div>

<script>
  var uxmalGltfUrl = "{{ url_for('static', filename='uxmal.gltf') }}";
</script>

<script>
  var bigcuboGltfUrl = "{{ url_for('static', filename='bigcubo.gltf') }}";
</script>

<script>
  mapboxgl.accessToken = "pk.eyJ1IjoiamxoZSIsImEiOiJjbGhtajRneXIxYzJ1M21xbzI2c2YwaDhjIn0.CowdxVUJQYhJtKUC-svhOQ";
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11', 
    center: [-99.1602753, 19.3735765],
    zoom: 14,
    pitch: 60,
    antialias: true,
    interactive: true
  });
  let maintenanceMarkers = [];

  // Manejador para cambio de estilos de mapa
  document.getElementById('style-list').addEventListener('change', function() {
    map.setStyle(this.value);
  });

  // Agregar marcadores y funcionalidades relacionadas después de cargar el estilo del mapa
  map.on('style.load', function () {
    // Aquí se agregará la capa personalizada del modelo 3D desde el JS externo

    $.ajax({
      url: '/dataframe_json_mantenimiento',
      type: 'GET',
      success: function(data){
        console.log(data);
        var lista_mantenimiento = data.map(item => {
          return {
            coordinates: [item.lon, item.lat],
            direccion: item.Direccion 
          };
        });

        lista_mantenimiento.forEach(function(item) {
          var marker = new mapboxgl.Marker({color: "#FF0000"})
            .setLngLat(item.coordinates)
            .addTo(map);

          var popup = new mapboxgl.Popup({ offset: 25 })
            .setText(item.direccion);

          marker.setPopup(popup);
          maintenanceMarkers.push(marker);
        });
      },
      error: function(error){
        console.log(error);
      }
    });

  
  }); 

</script>


<!-- Incluir el script externo que maneja el modelo 3D -->
<script src="{{ url_for('static', filename='js/cargar_uxmal.js') }}"></script>
<!-- Incluir el script para la vista en primera persona -->
<script src="{{ url_for('static', filename='js/first_personview.js') }}"></script>
<!-- Configurar el evento del botón para activar la vista en primera persona -->
<script>
  document.getElementById('toggle-markers-btn').addEventListener('click', function() {
    // Especifica las coordenadas y el nivel de zoom deseados
    const lat = 19.3735765;    // Latitud
    const lon = -99.1602753;   // Longitud
    const zoomLevel = 16;      // Nivel de zoom

    activateFirstPersonView(lat, lon, zoomLevel);
  });
</script>

{% endblock %}
