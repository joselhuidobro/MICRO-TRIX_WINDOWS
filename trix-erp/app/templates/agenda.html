{% extends "base.html" %}
{% block title %}
Dashboard
{% endblock %}
{% block customCSS %}

<!-- Enlace a los estilos CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/tabla_ventas.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/formulario.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/chatbot.css') }}">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">


{% endblock %}
{% block content %}


<!-- Inclusión de jQuery y jQuery UI -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>



<form action="{{ url_for('agenda.agregar_orden') }}" method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <h2>Inicio</h2>
    <div class="form-section">
        <div class="search-column">
            <!-- Búsqueda en Google Maps -->
            <p>Buscar en Google Maps</p>
            <script src="{{ url_for('static', filename='js/autocompletar.js') }}"></script>
            <script
                src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDVWlkQtoEbJEamknYtNYP0zmXVlgEfDy0&libraries=places&callback=initAutocomplete"
                async
                defer
            ></script>
            <input type="text" id="location-input" placeholder="Escribe una dirección">
            <input type="text" id="lat-output" placeholder="Latitud correspondiente a búsqueda" readonly>
            <input type="text" id="lon-output" placeholder="Longitud correspondiente" readonly>
            <button type="button" id="usar-datos-btn">Usar Datos</button>
            <button type="button" id="clasificar-dato-btn">Clasificar</button>
            <div id="resultado-clasificacion"></div>
        </div>

        <div class="form-row">
            <input type="text" name="cel" placeholder="Cel">
            <input type="text" name="nombre" placeholder="Nombre">
            <input type="date" name="fecha" placeholder="Fecha" id="fecha">
            <input type="text" id="direccion" name="direccion" placeholder="Dirección">
            <input type="text" name="concepto" placeholder="Concepto">

            <select id="categoria" name="categoria" placeholder="Categoria">
                <option value="Motor">Motor</option>
                <option value="Mantenimiento">Mantenimiento</option>
                <option value="Taller">Taller</option>
                <option value="Cotizacion">Cotizacion</option>
                <option value="Ajuste">Ajuste</option>
                <option value="Refacción">Refacción</option>
                <option value="Herreria">Herreria</option>
                <option value="Electronica">Electrónica</option>
                <option value="Garantia">Garantia</option>
                <option value="Programación">Programación de control</option>
                <option value="Levantamiento">Levantamiento</option>
            </select>
            <input type="text" name="no_semana" placeholder="Número de semana" id="semana">

            <select id="dia_semana" name="dia_semana">
                <option value="" disabled selected>Día de semana</option>
                <option value="Lunes">Lunes</option>
                <option value="Martes">Martes</option>
                <option value="Miércoles">Miércoles</option>
                <option value="Jueves">Jueves</option>
                <option value="Viernes">Viernes</option>
                <option value="Sábado">Sábado</option>
                <option value="Domingo">Domingo</option>
            </select>

            <input type="number" name="Cantidad" placeholder="Cantidad" id="cantidad" min="0">
            <input type="number" name="Precio_Unitario" placeholder="Precio Unitario" id="precio_unitario" min="0" step="0.01">
            <input type="number" name="Total_cotizado" placeholder="Total Cotizado" id="total_cotizado" readonly>
            <input type="number" name="Total_pagado" placeholder="Total pagado" id="total_pagado" min="0" step="0.01">
            <input type="number" name="pendiente" placeholder="Pendiente" id="pendiente" readonly>

            <select id="forma_de_pago" name="forma_de_pago">
                <option value="Efectivo">Efectivo</option>
                <option value="Transferencia">Transferencia</option>
                <option value="Tarjeta">Tarjeta</option>
                <option value="Cheque">Cheque</option>
            </select>

            <input type="text" id="lat" name="lat" placeholder="Latitud" readonly>
            <input type="text" id="lon" name="lon" placeholder="Longitud" readonly>

            <button type="submit">Guardar</button>
        </div>
    </div>
</form>

<!-- Botón de Actualizar -->
<button type="button" id="actualizar-btn">Actualizar</button>

    <div class="chatbot-container">
        <h3>Asistencia IA</h3>
        <div class="chatbox">
            <div class="messages" id="chat-messages">
            </div>
            <div class="input-area">
                <input type="text" id="user-input" placeholder="Escribe tu mensaje...">
                <button type="button" id="send-btn">Enviar</button>
            </div>
        </div>
    </div>

<!------------------- Tabla de Ventas -->
<table class="Tabla_V">
    <thead>
        <tr>
            <th>id</th>
            <th>Cel</th>
            <th>Nombre</th>
            <th>Fecha</th>
            <th>Direccion</th>
            <th>Concepto</th>
            <th>Categoria</th>
            <th>Semana</th>
            <th>Día</th>
            <th>Cantidad</th>
            <th>Precio Unitario</th>
            <th>T. Cotizado</th>
            <th>Pagado</th>
            <th>Forma de Pago</th>
            <th>Estado</th>
            <th>H. Llegada</th>
            <th>ACCION</th>
            <th>Cambiar Estado</th>
            <th>Horario</th>
            <th>Unidad TRIX</th>
        </tr>
    </thead>

    <tbody>
        {% for semana in semanas %}
        <tr>
            <td>{{ semana.id }}</td>
            <td>{{ semana.cel }}</td>
            <td>{{ semana.nombre }}</td>
            <td>{{ semana.fecha }}</td>
            <td>{{ semana.direccion }}</td>
            <td>{{ semana.concepto }}</td>
            <td>{{ semana.categoria }}</td>
            <td>{{ semana.no_semana }}</td>
            <td>{{ semana.dia_semana }}</td>
            <td>{{ semana.cantidad }}</td>
            <td>{{ semana.precio_unitario }}</td>
            <td>{{ semana.total_cotizado }}</td>
            <td>{{ semana.total_pagado }}</td>
            <td>{{ semana.forma_de_pago }}</td>
            <td class="{{ semana.estado }}">{{ semana.estado }}</td>
            <td>{{ semana.h_llegada }}</td>

            <td>
                <div class="btn-container">
                    <form action="{{ url_for('agenda.get_orden', id=semana.id) }}" method="GET" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button class="btn" type="submit">Editar</button>
                    </form>

                    <form action="{{ url_for('agenda.borrar_venta', id=semana.id) }}" method="POST" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button class="btn" type="submit">Borrar</button>
                    </form>

                    <label>
                        <input
                          type="checkbox"
                          id="en_ruta_checkbox_{{ semana.id }}"
                          onclick="updateRuta({{ semana.id }}, this.checked)"
                          {% if semana.en_ruta %} checked {% endif %}
                         >
                        En ruta
                      </label>
                </div>
            </td>

            <td>
                <form>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <select class="status-select" name="Status" onchange="updateStatusClass(this)"
                        style="width: 100px; height: 30px;" data-id="{{ semana.id }}">
                        <option value="Vacio" {% if semana.estado == 'Vacio' %} selected {% endif %}>Seleccionar</option>
                        <option value="facturar" {% if semana.estado == 'facturar' %} selected {% endif %}>Factura pendiente</option>
                        <option value="cotizar" {% if semana.estado == 'cotizar' %} selected {% endif %}>Cotización pendiente</option>
                        <option value="proceso" {% if semana.estado == 'proceso' %} selected {% endif %}>En proceso</option>
                        <option value="terminado" {% if semana.estado == 'terminado' %} selected {% endif %}>Terminado</option>
                        <option value="marcar_urgente" {% if semana.estado == 'marcar_urgente' %} selected {% endif %}>Marcar urgente</option>
                        <option value="retrasado" {% if semana.estado == 'retrasado' %} selected {% endif %}>Retrasado</option>
                        <option value="ciclo_de_ventas" {% if semana.estado == 'ciclo_de_ventas' %} selected {% endif %}>Ciclo de venta</option>
                        <option value="pagar" {% if semana.estado == 'pagar' %} selected {% endif %}>Por pagar</option>
                        <option value="programado" {% if semana.estado == 'programado' %} selected {% endif %}>Programado</option>
                        <option value="cancelo_cliente" {% if semana.estado == 'cancelo_cliente' %} selected {% endif %}>Canceló cliente</option>
                    </select>
                </form>
            </td>
            <td>
                <!-- Lista de Horarios -->
                <select class="time-select" style="width: 100px; height: 30px;" data-id="{{ semana.id }}">
                    <option value="00:00">----</option>
                    <option value="10:00">10:00</option>
                    <option value="10:30">10:30</option>
                    <option value="11:00">11:00</option>
                    <option value="11:30">11:30</option>
                    <option value="12:00">12:00</option>
                    <option value="12:30">12:30</option>
                    <option value="13:00">13:00</option>
                    <option value="13:30">13:30</option>
                    <option value="14:00">14:00</option>
                    <option value="14:30">14:30</option>
                    <option value="15:00">15:00</option>
                    <option value="15:30">15:30</option>
                    <option value="16:00">16:00</option>
                    <option value="16:30">16:30</option>
                    <option value="17:00">17:00</option>
                    <option value="17:30">17:30</option>
                    <option value="18:00">18:00</option>
                    <option value="18:30">18:30</option>
                    <option value="19:00">19:00</option>
                    <option value="19:30">19:30</option>
                    <option value="20:00">20:00</option>
                    <option value="20:30">20:30</option>
                    <option value="21:00">21:00</option>
                    <option value="21:30">21:30</option>
                    <option value="22:00">22:00</option>
                    <!-- ... más opciones ... -->
                </select>

                <select class="time-select" style="width: 100px; height: 30px;" data-id="{{ semana.id }}">
                    <option value="00:00">----</option>
                    <option value="10:00">10:00</option>
                </select>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Definición de variables globales para JavaScript -->
<script>
    const predictUrl = "{{ url_for('agenda.predict') }}";
    const csrfToken = "{{ csrf_token() }}";
</script>

<!-- Inclusión del script clasificar_boton.js -->
<script src="{{ url_for('static', filename='js/clasificar_boton.js') }}"></script>
<script src="{{ url_for('static', filename='js/usar_datos.js') }}"></script>


<!-- Script para calcular el Total Cotizado -->
<script>
    document.getElementById("cantidad").addEventListener("input", function () {
        var cantidad = parseFloat(document.getElementById("cantidad").value) || 0;
        var precio_unitario = parseFloat(document.getElementById("precio_unitario").value) || 0;
        document.getElementById("total_cotizado").value = (cantidad * precio_unitario).toFixed(2);
    });

    document.getElementById("precio_unitario").addEventListener("input", function () {
        var cantidad = parseFloat(document.getElementById("cantidad").value) || 0;
        var precio_unitario = parseFloat(document.getElementById("precio_unitario").value) || 0;
        document.getElementById("total_cotizado").value = (cantidad * precio_unitario).toFixed(2);
    });
</script>

<!-- Script para calcular el Pendiente -->
<script>
    document.getElementById("total_cotizado").addEventListener("input", function () {
        var total_cotizado = parseFloat(document.getElementById("total_cotizado").value) || 0;
        var total_pagado = parseFloat(document.getElementById("total_pagado").value) || 0;
        document.getElementById("pendiente").value = (total_cotizado - total_pagado).toFixed(2);
    });

    document.getElementById("total_pagado").addEventListener("input", function () {
        var total_cotizado = parseFloat(document.getElementById("total_cotizado").value) || 0;
        var total_pagado = parseFloat(document.getElementById("total_pagado").value) || 0;
        document.getElementById("pendiente").value = (total_cotizado - total_pagado).toFixed(2);
    });
</script>

<!-- Script para asignar la fecha actual al campo Fecha -->
<script>
    document.getElementById("fecha").value = new Date().toISOString().slice(0, 10);
</script>

<!-- Script para actualizar la clase del estado -->
<script>
    function updateStatusClass(selectElement) {
        // Remover las clases previas del td (asumiendo que la celda estado está en la misma fila)
        var tdElement = selectElement.closest('tr').querySelector('td.estado'); // Añadir clase 'estado' al td correspondiente
        if (tdElement) {
            // Limpia las clases del td
            tdElement.className = '';
            // Asigna la nueva clase según el estado seleccionado
            var statusValue = selectElement.value;
            tdElement.classList.add(statusValue);
            // Actualiza el texto del td
            tdElement.textContent = statusValue.charAt(0).toUpperCase() + statusValue.slice(1);
        }
    }
</script>

// Agrega este script al final de tu bloque customJS
<script>
    $(document).ready(function(){
        $('.chatbot-container h3').click(function(){
            $('.chatbot-container').toggleClass('active');
        });
    });
</script>

<script>
    function updateRuta(id, checked) {
      // Prepara la URL de tu endpoint
      const url = "{{ url_for('agenda.update_ruta_ajax') }}";
  
      // Prepara los datos a enviar en JSON
      const data = {
        id: id,
        en_ruta: checked  // True/False
      };
  
      // Enviar petición fetch
      fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token() }}"  // Si usas Flask-WTF CSRF
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        console.log("Respuesta del servidor:", data);
        // Aquí podrías actualizar la interfaz si lo deseas
      })
      .catch(error => {
        console.error("Error al actualizar en_ruta:", error);
        // Podrías manejar el error mostrando un mensaje al usuario
      });
    }
  </script>




<!-- Script para manejar cambios en el estado mediante AJAX -->
<script>
    $(document).ready(function () {
        $('.status-select').change(function () {
            var status = $(this).val();
            var id = Number($(this).data('id'));  // Convierte el id a un número
            var csrf_token = $('input[name="csrf_token"]').val();
            $.ajax({
                url: "{{ url_for('agenda.update_status') }}",  // Usa Flask para generar la URL
                method: 'POST',
                data: JSON.stringify({ 'id': id, 'status': status }),
                contentType: 'application/json',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-CSRFToken', csrf_token);
                },
                success: function (response) {
                    console.log(response);
                },
                error: function (error) {
                    console.log(error);
                }
            });
        });
    });
</script>

<!-- Script para manejar el botón "Actualizar" -->
<script>
    $(document).ready(function () {
        $('#actualizar-btn').click(function () {
            if (!confirm("¿Estás seguro de que deseas actualizar la tabla? Esta acción copiará todas las órdenes actuales al historial.")) {
                return;
            }

            // Obtener el token CSRF
            var csrf_token = $('input[name="csrf_token"]').val();

            // Enviar la solicitud AJAX
            $.ajax({
                url: "{{ url_for('agenda.actualizar_tabla') }}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({}),  // Si necesitas enviar datos adicionales, inclúyelos aquí
                headers: {
                    'X-CSRFToken': csrf_token
                },
                success: function (response) {
                    alert(response.mensaje);
                    // Opcional: Actualizar la tabla o realizar alguna otra acción
                },
                error: function (xhr) {
                    var errorMsg = "Ocurrió un error al actualizar la tabla.";
                    if (xhr.responseJSON && xhr.responseJSON.mensaje) {
                        errorMsg = xhr.responseJSON.mensaje;
                    }
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg += "\nDetalles: " + xhr.responseJSON.error;
                    }
                    alert(errorMsg);
                }
            });
        });
    });
</script>

<!-- Mensajes flash de Flask -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="flash-messages">
    {% for category, message in messages %}
    <div class="flash-message {{ category }}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

{% endblock %}